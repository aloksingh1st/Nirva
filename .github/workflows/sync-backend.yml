name: Sync backend with monorepo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # runs daily at midnight UTC

permissions:
  contents: write  # required for pushing commits to other repos

jobs:
  sync-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout monorepo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verify token access
        run: |
          echo "Verifying token access..."
          curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" https://api.github.com/user | jq '.login'

      - name: Verify repo visibility
        run: |
          echo "Checking target repo visibility..."
          curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" https://api.github.com/repos/aloksingh1st/auth-microservice | jq '.private, .full_name'

      - name: Add backend repo as remote (private)
        run: |
          set -e
          git remote add backend-repo https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/aloksingh1st/auth-microservice.git
          git fetch backend-repo main --tags || git fetch backend-repo master --tags

      - name: Sync backend folder to backend-repo
        run: |
          set -e
          mkdir sync-tmp
          rsync -av --delete ./backend/ ./sync-tmp/
          cd sync-tmp
          git init
          git remote add origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/aloksingh1st/auth-microservice.git
          git checkout -b main || git checkout -b master
          git add .
          git commit -m "chore: sync from monorepo $(date -u '+%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push -f origin main || git push -f origin master

      - name: Done
        run: echo "âœ… Backend sync completed successfully!"
